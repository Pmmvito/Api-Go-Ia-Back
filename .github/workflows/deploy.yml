name: Deploy API Go no Servidor Ubuntu

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
        run: |
          echo "ğŸš€ Iniciando deploy da API Go"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ“ Mensagem: ${{ github.event.head_commit.message }}"
          echo "â° Data: $(date)"

      - name: ğŸšš Conectar via SSH e fazer Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m

          script: |
            # 1. Navegue atÃ© a pasta do projeto
            echo "ğŸ“ Navegando para /DATA/Downloads/Api-Go-Ia-Back"
            cd /DATA/Downloads/Api-Go-Ia-Back
            
            # 2. Puxe as Ãºltimas alteraÃ§Ãµes
            echo "ğŸ“¥ Baixando atualizaÃ§Ãµes..."
            git fetch origin main
            git reset --hard origin/main
            
            # 3. Baixe dependÃªncias
            echo "ğŸ“¦ Baixando dependÃªncias (go mod tidy)..."
            go mod tidy
            
            # 4. Compile o novo binÃ¡rio
            echo "ğŸ”¨ Compilando a aplicaÃ§Ã£o (go build)..."
            go build -o api-go-ia main.go
            
            # 5. Reinicie o serviÃ§o (O Systemd cuida de parar o antigo e iniciar o novo)
            echo "â–¶ï¸ Reiniciando o serviÃ§o (systemctl restart)..."
            sudo systemctl restart api-go-ia.service
            
            echo "ğŸ‰ Deploy finalizado com sucesso!"

      - name: âœ… Deploy ConcluÃ­do
        if: success()
        run: echo "ğŸ‰ Deploy realizado com sucesso!"

      - name: âŒ Deploy Falhou
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs."
          exit 1