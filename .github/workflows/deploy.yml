name: Deploy API Go no Servidor Ubuntu

on:
  push:
    branches:
      - main  # Ou a branch que voc√™ usa
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üìã Informa√ß√µes do Deploy
        run: |
          echo "üöÄ Iniciando deploy da API Go"
          echo "üì¶ Commit: ${{ github.sha }}"
          echo "ÔøΩ Autor: ${{ github.actor }}"
          echo "üìù Mensagem: ${{ github.event.head_commit.message }}"
          echo "‚è∞ Data: $(date)"

      - name:  Conectar via SSH e fazer Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m

          script: |
            set -e  # Para execu√ß√£o se houver erro
            
            echo "================================================"
            echo "üîç ETAPA 1: Verificando ambiente"
            echo "================================================"
            echo "üìÇ Diret√≥rio atual: $(pwd)"
            echo "üë§ Usu√°rio: $(whoami)"
            echo "üêπ Vers√£o Go: $(go version)"
            
            echo ""
            echo "================================================"
            echo "üìÅ ETAPA 2: Navegando para o projeto"
            echo "================================================"
            cd /DATA/Downloads/Api-Go-Ia-Back
            echo "‚úÖ Diret√≥rio do projeto: $(pwd)"
            
            echo ""
            echo "================================================"
            echo "üì• ETAPA 3: Atualizando c√≥digo do reposit√≥rio"
            echo "================================================"
            echo "üîÑ Branch atual: $(git branch --show-current)"
            echo "üìå Commit atual (antes): $(git rev-parse --short HEAD)"
            
            # Verifica se h√° mudan√ßas locais
            if ! git diff-index --quiet HEAD --; then
              echo "‚ö†Ô∏è Detectadas mudan√ßas locais, fazendo stash..."
              git stash save "Auto-stash antes do deploy $(date)"
            fi
            
            git fetch origin main
            git reset --hard origin/main
            echo "üìå Commit atual (depois): $(git rev-parse --short HEAD)"
            echo "‚úÖ C√≥digo atualizado com sucesso"
            
            echo ""
            echo "================================================"
            echo "üì¶ ETAPA 4: Gerenciando depend√™ncias"
            echo "================================================"
            go mod tidy
            echo "‚úÖ Depend√™ncias verificadas"
            
            echo ""
            echo "================================================"
            echo "üî® ETAPA 5: Compilando a aplica√ß√£o"
            echo "================================================"
            echo "üèóÔ∏è Iniciando compila√ß√£o..."
            go build -v -o api-go-ia main.go
            echo "‚úÖ Compila√ß√£o conclu√≠da com sucesso"
            
            echo ""
            echo "================================================"
            echo "üìä ETAPA 6: Verificando bin√°rio"
            echo "================================================"
            ls -lh api-go-ia
            echo "‚úÖ Bin√°rio verificado"
            
            echo ""
            echo "================================================"
            echo "üîÑ ETAPA 7: Reiniciando o servi√ßo"
            echo "================================================"
            
            # Tenta parar o servi√ßo com sudo (se dispon√≠vel)
            echo "‚è∏Ô∏è Tentando parar servi√ßo..."
            if command -v sudo &> /dev/null && sudo -n systemctl stop api-go-ia.service 2>/dev/null; then
              echo "‚úÖ Servi√ßo parado com systemctl"
              
              echo "‚ñ∂Ô∏è Iniciando servi√ßo..."
              sudo systemctl start api-go-ia.service
              
              echo "‚è≥ Aguardando 3 segundos..."
              sleep 3
              
              echo "üîç Verificando status do servi√ßo..."
              sudo systemctl status api-go-ia.service --no-pager || true
            else
              echo "‚ö†Ô∏è sudo n√£o dispon√≠vel ou servi√ßo n√£o gerenciado por systemd"
              echo "üîÑ Tentando reiniciar manualmente..."
              
              # Mata processo existente
              pkill -f "api-go-ia" || echo "Nenhum processo anterior encontrado"
              
              # Aguarda um pouco
              sleep 2
              
              # Inicia novo processo em background
              nohup ./api-go-ia > /tmp/api-go-ia.log 2>&1 &
              
              echo "‚úÖ Processo iniciado manualmente (PID: $!)"
              echo "‚è≥ Aguardando 3 segundos..."
              sleep 3
              
              # Verifica se o processo est√° rodando
              if pgrep -f "api-go-ia" > /dev/null; then
                echo "‚úÖ Processo est√° rodando"
              else
                echo "‚ùå ERRO: Processo n√£o iniciou"
                echo "üìã √öltimas linhas do log:"
                tail -n 20 /tmp/api-go-ia.log || echo "Log n√£o dispon√≠vel"
                exit 1
              fi
            fi
            
            echo ""
            echo "================================================"
            echo "‚úÖ ETAPA 8: Valida√ß√£o final"
            echo "================================================"
            
            # Verifica se systemctl est√° dispon√≠vel com sudo
            if command -v sudo &> /dev/null && sudo -n systemctl is-active --quiet api-go-ia.service 2>/dev/null; then
              echo "‚úÖ Servi√ßo systemd est√° ATIVO"
              echo "üéâ Deploy conclu√≠do com SUCESSO!"
            elif pgrep -f "api-go-ia" > /dev/null; then
              echo "‚úÖ Processo manual est√° RODANDO"
              echo "üìä Processos ativos:"
              ps aux | grep api-go-ia | grep -v grep || true
              echo "üéâ Deploy conclu√≠do com SUCESSO!"
            else
              echo "‚ùå ERRO: Servi√ßo/Processo N√ÉO est√° ativo"
              echo "üìã Tentando obter logs..."
              if [ -f /tmp/api-go-ia.log ]; then
                echo "Log manual:"
                tail -n 30 /tmp/api-go-ia.log
              fi
              if command -v sudo &> /dev/null; then
                sudo journalctl -u api-go-ia.service -n 20 --no-pager 2>/dev/null || true
              fi
              exit 1
            fi
            
            echo ""
            echo "================================================"
            echo "ÔøΩ RESUMO DO DEPLOY"
            echo "================================================"
            echo "‚úÖ Commit: $(git rev-parse --short HEAD)"
            echo "‚úÖ Data: $(date)"
            echo "‚úÖ Status: SUCCESS"
            echo "================================================"

      - name: ‚úÖ Deploy Conclu√≠do
        if: success()
        run: |
          echo "üéâ Deploy realizado com sucesso!"
          echo "üåê API dispon√≠vel em: http://${{ secrets.SERVER_HOST }}:61489"

      - name: ‚ùå Deploy Falhou
        if: failure()
        run: |
          echo "‚ùå Deploy falhou! Verifique os logs acima."
          exit 1
