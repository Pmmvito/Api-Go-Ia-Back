name: Deploy API Go no Servidor Ubuntu

on:
  push:
    branches:
      - main  # Ou a branch que vocÃª usa
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
        run: |
          echo "ğŸš€ Iniciando deploy da API Go"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ï¿½ Autor: ${{ github.actor }}"
          echo "ğŸ“ Mensagem: ${{ github.event.head_commit.message }}"
          echo "â° Data: $(date)"

      - name: ï¿½ğŸšš Conectar via SSH e fazer Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script_stop: true  # Para execuÃ§Ã£o se algum comando falhar

          script: |
            set -e  # Para execuÃ§Ã£o se houver erro
            
            echo "================================================"
            echo "ğŸ” ETAPA 1: Verificando ambiente"
            echo "================================================"
            echo "ğŸ“‚ DiretÃ³rio atual: $(pwd)"
            echo "ğŸ‘¤ UsuÃ¡rio: $(whoami)"
            echo "ğŸ¹ VersÃ£o Go: $(go version)"
            
            echo ""
            echo "================================================"
            echo "ğŸ“ ETAPA 2: Navegando para o projeto"
            echo "================================================"
            cd /DATA/Downloads/Api-Go-Ia-Back
            echo "âœ… DiretÃ³rio do projeto: $(pwd)"
            
            echo ""
            echo "================================================"
            echo "ğŸ“¥ ETAPA 3: Atualizando cÃ³digo do repositÃ³rio"
            echo "================================================"
            echo "ğŸ”„ Branch atual: $(git branch --show-current)"
            echo "ğŸ“Œ Commit atual (antes): $(git rev-parse --short HEAD)"
            git pull origin main
            echo "ğŸ“Œ Commit atual (depois): $(git rev-parse --short HEAD)"
            echo "âœ… CÃ³digo atualizado com sucesso"
            
            echo ""
            echo "================================================"
            echo "ğŸ“¦ ETAPA 4: Gerenciando dependÃªncias"
            echo "================================================"
            go mod tidy
            echo "âœ… DependÃªncias verificadas"
            
            echo ""
            echo "================================================"
            echo "ğŸ”¨ ETAPA 5: Compilando a aplicaÃ§Ã£o"
            echo "================================================"
            echo "ğŸ—ï¸ Iniciando compilaÃ§Ã£o..."
            go build -v -o api-go-ia main.go
            echo "âœ… CompilaÃ§Ã£o concluÃ­da com sucesso"
            
            echo ""
            echo "================================================"
            echo "ğŸ“Š ETAPA 6: Verificando binÃ¡rio"
            echo "================================================"
            ls -lh api-go-ia
            echo "âœ… BinÃ¡rio verificado"
            
            echo ""
            echo "================================================"
            echo "ğŸ”„ ETAPA 7: Reiniciando o serviÃ§o"
            echo "================================================"
            echo "â¸ï¸ Parando serviÃ§o..."
            sudo systemctl stop api-go-ia.service || echo "âš ï¸ ServiÃ§o jÃ¡ estava parado"
            
            echo "â–¶ï¸ Iniciando serviÃ§o..."
            sudo systemctl start api-go-ia.service
            
            echo "â³ Aguardando 3 segundos..."
            sleep 3
            
            echo "ğŸ” Verificando status do serviÃ§o..."
            sudo systemctl status api-go-ia.service --no-pager || true
            
            echo ""
            echo "================================================"
            echo "âœ… ETAPA 8: ValidaÃ§Ã£o final"
            echo "================================================"
            if sudo systemctl is-active --quiet api-go-ia.service; then
              echo "âœ… ServiÃ§o estÃ¡ ATIVO"
              echo "ğŸ‰ Deploy concluÃ­do com SUCESSO!"
            else
              echo "âŒ ERRO: ServiÃ§o NÃƒO estÃ¡ ativo"
              echo "ğŸ“‹ Ãšltimas 20 linhas do log:"
              sudo journalctl -u api-go-ia.service -n 20 --no-pager
              exit 1
            fi
            
            echo ""
            echo "================================================"
            echo "ï¿½ RESUMO DO DEPLOY"
            echo "================================================"
            echo "âœ… Commit: $(git rev-parse --short HEAD)"
            echo "âœ… Data: $(date)"
            echo "âœ… Status: SUCCESS"
            echo "================================================"

      - name: âœ… Deploy ConcluÃ­do
        if: success()
        run: |
          echo "ğŸ‰ Deploy realizado com sucesso!"
          echo "ğŸŒ API disponÃ­vel em: http://${{ secrets.SERVER_HOST }}:61489"

      - name: âŒ Deploy Falhou
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs acima."
          exit 1
