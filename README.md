# Golang API de Gerenciamento de Notas Fiscais com IA

Uma **API REST** moderna e eficiente com sistema completo de autentica√ß√£o JWT (Bearer Token), **escaneamento de notas fiscais com IA Google Gemini**, e **banco de dados normalizado** seguindo as melhores pr√°ticas acad√™micas, desenvolvida em **Go (Golang)**.

## üöÄ Sobre o Projeto

Esta## üîí Seguran√ßa

### Autentica√ß√£o JWT
- Tokens JWT v√°lidos por 7 dias
- Assinatura HMAC-SHA256
- Tokens enviados via header `Authorization: Bearer <token>`

### Senhas
- Hash bcrypt com salt autom√°tico
- Custo padr√£o do bcrypt (10 rounds)
- Senha nunca retornada nas respostas da API

### Vari√°veis de Ambiente
- `JWT_SECRET`: Chave secreta para assinatura de tokens (MUDE EM PRODU√á√ÉO!)
- `DATABASE_DSN`: String de conex√£o do PostgreSQL
- `GEMINI_API_KEY`: Chave API do Google Gemini (obtenha gratuitamente)

### Prote√ß√£o de Dados
- ‚úÖ Imagens de notas armazenadas apenas como base64
- ‚úÖ Relacionamento User ‚Üí Receipt garante isolamento de dados
- ‚úÖ Todas as queries verificam ownership via JWT

## ü§ñ Google Gemini AI

### Como Funciona
1. Usu√°rio envia imagem da nota fiscal (base64)
2. API envia para Google Gemini com prompt estruturado
3. IA retorna JSON com:
   - Nome do estabelecimento
   - Data da compra
   - Lista de items com descri√ß√£o, quantidade, pre√ßo
   - **Categoria sugerida para cada item**
   - Subtotal, descontos, total
4. API salva tudo no banco de dados normalizado

### Prompt da IA
```text
Voc√™ √© um assistente especializado em analisar notas fiscais brasileiras...
Para cada item, voc√™ DEVE categorizar usando uma dessas op√ß√µes:
- Alimenta√ß√£o üçΩÔ∏è
- Bebidas ü•§
- Frutas üçé
... (15 categorias)
```

### Obter API Key Gratuita
1. Acesse [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Fa√ßa login com sua conta Google
3. Clique em "Create API Key"
4. Copie a chave e adicione no `.env`

## üéì Adequado para TCC

Esta API foi desenvolvida seguindo as melhores pr√°ticas acad√™micas:

### ‚úÖ Banco de Dados Normalizado
- Terceira Forma Normal (3NF)
- Relacionamentos com Foreign Keys
- Diagramas ER completos
- Queries otimizadas com INNER JOINs

### ‚úÖ Documenta√ß√£o Completa
- README detalhado
- Swagger para API
- Diagrama de relacionamentos
- Changelog de mudan√ßas

### ‚úÖ Arquitetura Limpa
- Separa√ß√£o de responsabilidades (MVC-like)
- Handlers, Schemas, Config separados
- Middleware de autentica√ß√£o
- Valida√ß√µes de input

### ‚úÖ Tecnologias Modernas
- Go (linguagem compilada, perform√°tica)
- PostgreSQL (banco robusto)
- Google Gemini AI (IA de √∫ltima gera√ß√£o)
- JWT (padr√£o de mercado)

Veja mais detalhes em:
- [`DATABASE_STRUCTURE.md`](DATABASE_STRUCTURE.md) - Estrutura completa do banco
- [`CHANGELOG_NORMALIZATION.md`](CHANGELOG_NORMALIZATION.md) - Processo de normaliza√ß√£o sistema robusto com:

- ‚úÖ **Registro de usu√°rios** com hash de senha (bcrypt)
- ‚úÖ **Login com JWT** (JSON Web Tokens)
- ‚úÖ **Sess√£o Bearer Token** para rotas protegidas
- ‚úÖ **Escaneamento de notas fiscais** com Google Gemini AI
- ‚úÖ **Categoriza√ß√£o autom√°tica** de produtos com IA
- ‚úÖ **Sistema completo de categorias** (CRUD)
- ‚úÖ **Banco de dados normalizado** (3NF) com relacionamentos adequados
- ‚úÖ **Filtros avan√ßados** por categoria e per√≠odo
- ‚úÖ **15 categorias padr√£o** pr√©-configuradas

## üéØ Funcionalidades Principais

### üì∏ Escaneamento de Notas Fiscais
- Envie uma imagem de nota fiscal (base64)
- IA extrai: estabelecimento, data, items, pre√ßos, totais
- **Categoriza√ß√£o autom√°tica** de cada item

### üè∑Ô∏è Sistema de Categorias
- 15 categorias padr√£o com emojis e cores
- CRUD completo (Create, Read, Update, Delete)
- Relacionamento com items via Foreign Key

### üìä Banco de Dados Normalizado
- **Users** ‚Üí **Receipts** ‚Üí **ReceiptItems** ‚Üí **Categories**
- Foreign Keys com CASCADE delete
- Queries otimizadas com INNER JOINs
- Preparado para aprova√ß√£o em TCC

### üîç Filtros e Buscas
- Listar todos os items
- Filtrar por categoria
- Filtrar por per√≠odo (data in√≠cio/fim)
- Agrupar por categoria com estat√≠sticas

## üõ†Ô∏è Tecnologias Utilizadas

- **[Go](https://golang.org/)** - Linguagem de programa√ß√£o
- **[Gin](https://gin-gonic.com/)** - Framework web HTTP
- **[GORM](https://gorm.io/)** - ORM (Object Relational Mapping)
- **[PostgreSQL](https://www.postgresql.org/)** - Banco de dados relacional
- **[JWT](https://github.com/golang-jwt/jwt)** - JSON Web Tokens para autentica√ß√£o
- **[bcrypt](https://pkg.go.dev/golang.org/x/crypto/bcrypt)** - Hash de senhas
- **[Google Gemini AI](https://ai.google.dev/)** - Intelig√™ncia Artificial para OCR e categoriza√ß√£o
- **[Swaggo](https://github.com/swaggo/swag)** - Gera√ß√£o autom√°tica de documenta√ß√£o Swagger
- **[godotenv](https://github.com/joho/godotenv)** - Gerenciamento de vari√°veis de ambiente

## üìã Pr√©-requisitos

- Go 1.21 ou superior
- PostgreSQL 12 ou superior
- Google Gemini API Key (gratuita em [Google AI Studio](https://makersuite.google.com/app/apikey))
- Make (opcional, para usar os comandos do Makefile)

## üöÄ Como Executar

### 1. Clone o reposit√≥rio
```bash
git clone https://github.com/Pmmvito/Golang-Api-Exemple.git
cd Golang-Api-Exemple
```

### 2. Configure as vari√°veis de ambiente
Copie o arquivo `.env.example` para `.env` e configure suas credenciais:
```bash
cp .env.example .env
```

Edite o arquivo `.env`:
```env
DATABASE_DSN=postgresql://usuario:senha@localhost:5432/nome_do_banco?sslmode=disable
JWT_SECRET=sua-chave-secreta-super-segura-mude-isso-em-producao
GEMINI_API_KEY=sua-chave-api-do-google-gemini
```

### 3. Instale as depend√™ncias
```bash
go mod tidy
```

### 4. Execute a aplica√ß√£o
```bash
go run main.go
```

A API estar√° dispon√≠vel em: `http://localhost:8080`

## üìö Documenta√ß√£o da API

### Swagger UI
A documenta√ß√£o interativa da API est√° dispon√≠vel em:
```
http://localhost:8080/swagger/index.html
```

### Endpoints Principais

#### üîì Rotas P√∫blicas (Sem Autentica√ß√£o)

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `POST` | `/api/v1/register` | Registrar novo usu√°rio |
| `POST` | `/api/v1/login` | Login (retorna JWT token) |

#### üîí Rotas Protegidas (Requerem Bearer Token)

**Usu√°rio:**
| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `GET` | `/api/v1/me` | Obter dados do usu√°rio autenticado |

**Notas Fiscais:**
| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `POST` | `/api/v1/scan-receipt` | Escanear nota fiscal com IA |
| `GET` | `/api/v1/receipts` | Listar todos os recibos |
| `GET` | `/api/v1/receipt/:id` | Obter recibo espec√≠fico |
| `PATCH` | `/api/v1/receipt/:id` | Atualizar recibo |
| `DELETE` | `/api/v1/receipt/:id` | Deletar recibo |

**Items:**
| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `GET` | `/api/v1/items` | Listar todos os items |
| `GET` | `/api/v1/items/filter` | Filtrar items (categoria, data) |
| `GET` | `/api/v1/receipt/:id/item/:itemId` | Obter item espec√≠fico |
| `PATCH` | `/api/v1/receipt/:id/item/:itemId` | Atualizar item |

**Categorias:**
| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| `POST` | `/api/v1/category` | Criar categoria |
| `GET` | `/api/v1/categories` | Listar todas as categorias |
| `GET` | `/api/v1/category/:id` | Obter categoria espec√≠fica |
| `PATCH` | `/api/v1/category/:id` | Atualizar categoria |
| `DELETE` | `/api/v1/category/:id` | Deletar categoria |

### Exemplo de Uso

#### 1. Registrar novo usu√°rio
```bash
curl -X POST http://localhost:8080/api/v1/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Jo√£o Silva",
    "email": "usuario@exemplo.com",
    "password": "senha123"
  }'
```

#### 2. Login
```bash
curl -X POST http://localhost:8080/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario@exemplo.com",
    "password": "senha123"
  }'
```

#### 3. Escanear Nota Fiscal
```bash
curl -X POST http://localhost:8080/api/v1/scan-receipt \
  -H "Authorization: Bearer SEU_TOKEN_JWT" \
  -H "Content-Type: application/json" \
  -d '{
    "imageBase64": "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
    "currency": "BRL",
    "locale": "pt-BR"
  }'
```

**Resposta:**
```json
{
  "message": "Receipt scanned successfully",
  "data": {
    "id": 1,
    "storeName": "Supermercado Exemplo",
    "date": "2024-01-15",
    "items": [
      {
        "id": 1,
        "description": "Arroz 5kg",
        "quantity": 1,
        "unit": "un",
        "unitPrice": 25.90,
        "total": 25.90,
        "category": {
          "id": 1,
          "name": "Alimenta√ß√£o",
          "icon": "üçΩÔ∏è",
          "color": "#FF6B6B"
        }
      }
    ],
    "subtotal": 150.50,
    "discount": 5.00,
    "total": 145.50,
    "currency": "BRL",
    "confidence": 0.95
  }
}
```

#### 4. Listar Categorias
```bash
curl -X GET http://localhost:8080/api/v1/categories \
  -H "Authorization: Bearer SEU_TOKEN_JWT"
```

**Resposta:**
```json
{
  "message": "Categories retrieved successfully",
  "data": [
    {
      "id": 1,
      "name": "Alimenta√ß√£o",
      "description": "Alimentos em geral",
      "icon": "üçΩÔ∏è",
      "color": "#FF6B6B"
    },
    {
      "id": 2,
      "name": "Bebidas",
      "description": "Bebidas alco√≥licas e n√£o alco√≥licas",
      "icon": "ü•§",
      "color": "#4ECDC4"
    }
  ]
}
```

#### 5. Filtrar Items por Categoria
```bash
curl -X GET "http://localhost:8080/api/v1/items/filter?category=Alimenta√ß√£o&startDate=2024-01-01&endDate=2024-01-31" \
  -H "Authorization: Bearer SEU_TOKEN_JWT"
```

**Resposta:**
```json
{
  "message": "Items retrieved successfully",
  "totalItems": 25,
  "filters": {
    "category": "Alimenta√ß√£o",
    "startDate": "2024-01-01",
    "endDate": "2024-01-31"
  },
  "groupedByCategory": [
    {
      "categoryName": "Alimenta√ß√£o",
      "items": [...],
      "totalAmount": 450.75,
      "itemCount": 25
    }
  ]
}
```

## üèóÔ∏è Estrutura do Projeto

```
‚îú‚îÄ‚îÄ config/             # Configura√ß√µes (DB, Logger)
‚îÇ   ‚îú‚îÄ‚îÄ config.go       # Inicializa√ß√£o geral
‚îÇ   ‚îú‚îÄ‚îÄ logger.go       # Sistema de logging
‚îÇ   ‚îú‚îÄ‚îÄ postgres.go     # Conex√£o PostgreSQL + Migrations
‚îÇ   ‚îî‚îÄ‚îÄ sqlite.go       # Conex√£o SQLite (backup)
‚îú‚îÄ‚îÄ handler/            # Handlers HTTP (Controllers)
‚îÇ   ‚îú‚îÄ‚îÄ handler.go      # Inicializador de handlers
‚îÇ   ‚îú‚îÄ‚îÄ auth.go         # Handlers de autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ scanReceipt.go  # Handlers de notas fiscais e items
‚îÇ   ‚îú‚îÄ‚îÄ category.go     # Handlers de categorias (CRUD)
‚îÇ   ‚îú‚îÄ‚îÄ request.go      # Valida√ß√£o de requests
‚îÇ   ‚îî‚îÄ‚îÄ response.go     # Respostas padronizadas
‚îú‚îÄ‚îÄ router/             # Configura√ß√£o de rotas
‚îÇ   ‚îú‚îÄ‚îÄ router.go       # Inicializa√ß√£o do Gin
‚îÇ   ‚îú‚îÄ‚îÄ routes.go       # Defini√ß√£o de rotas (16 endpoints)
‚îÇ   ‚îî‚îÄ‚îÄ middleware.go   # Middleware de autentica√ß√£o JWT
‚îú‚îÄ‚îÄ schemas/            # Modelos de dados (GORM)
‚îÇ   ‚îú‚îÄ‚îÄ user.go         # User (1) ‚Üí Receipts (N)
‚îÇ   ‚îú‚îÄ‚îÄ receipt.go      # Receipt (1) ‚Üí ReceiptItems (N)
‚îÇ   ‚îú‚îÄ‚îÄ category.go     # Category (1) ‚Üê ReceiptItems (N)
‚îÇ   ‚îî‚îÄ‚îÄ opening.go      # Modelo de vagas (legado)
‚îú‚îÄ‚îÄ docs/               # Documenta√ß√£o Swagger gerada
‚îú‚îÄ‚îÄ main.go             # Ponto de entrada da aplica√ß√£o
‚îú‚îÄ‚îÄ .env                # Vari√°veis de ambiente (n√£o commitado)
‚îú‚îÄ‚îÄ .env.example        # Exemplo de vari√°veis de ambiente
‚îú‚îÄ‚îÄ DATABASE_STRUCTURE.md # Documenta√ß√£o completa do banco de dados
‚îú‚îÄ‚îÄ CHANGELOG_NORMALIZATION.md # Hist√≥rico de mudan√ßas
‚îî‚îÄ‚îÄ README.md           # Documenta√ß√£o do projeto
```

## üóÑÔ∏è Banco de Dados

### Relacionamentos (ER Diagram)
```
Users (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Receipts (N) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ReceiptItems (N) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Categories (M)
   ‚îÇ                  ‚îÇ                      ‚îÇ                       ‚îÇ
   ‚îî‚îÄ FK: user_id     ‚îî‚îÄ FK: receipt_id     ‚îî‚îÄ FK: category_id      ‚îî‚îÄ PK: id
```

### Caracter√≠sticas
- ‚úÖ **Normaliza√ß√£o 3NF**: Sem redund√¢ncia de dados
- ‚úÖ **Foreign Keys**: Integridade referencial garantida
- ‚úÖ **CASCADE Deletes**: Apagar usu√°rio remove tudo automaticamente
- ‚úÖ **Indexes**: Performance otimizada em todas as FKs
- ‚úÖ **Transa√ß√µes ACID**: Garantia de consist√™ncia

Veja documenta√ß√£o completa em [`DATABASE_STRUCTURE.md`](DATABASE_STRUCTURE.md)

## üè∑Ô∏è Categorias Padr√£o

15 categorias pr√©-configuradas com emojis e cores:

| Categoria | Emoji | Cor |
|-----------|-------|-----|
| Alimenta√ß√£o | üçΩÔ∏è | #FF6B6B |
| Bebidas | ü•§ | #4ECDC4 |
| Frutas | üçé | #95E1D3 |
| Verduras e Legumes | ü•¨ | #38A169 |
| Carnes e Peixes | ü•© | #E53E3E |
| Latic√≠nios | ü•õ | #F6E05E |
| Padaria | üçû | #D69E2E |
| Limpeza | üßπ | #3182CE |
| Higiene Pessoal | üß¥ | #805AD5 |
| Beb√™ | üë∂ | #FBB6CE |
| Pet | üêæ | #F6AD55 |
| Congelados | ‚ùÑÔ∏è | #63B3ED |
| Snacks | üç™ | #FC8181 |
| Temperos | üßÇ | #68D391 |
| Outros | üì¶ | #A0AEC0 |

## ÔøΩ Seguran√ßa

### Autentica√ß√£o JWT
- Tokens JWT v√°lidos por 7 dias
- Assinatura HMAC-SHA256
- Tokens enviados via header `Authorization: Bearer <token>`

### Senhas
- Hash bcrypt com salt autom√°tico
- Custo padr√£o do bcrypt (10 rounds)
- Senha nunca retornada nas respostas da API

### Vari√°veis de Ambiente
- `JWT_SECRET`: Chave secreta para assinatura de tokens (MUDE EM PRODU√á√ÉO!)
- `DATABASE_DSN`: String de conex√£o do PostgreSQL

## ÔøΩüìñ Gerando Documenta√ß√£o Swagger

Este projeto utiliza **Swaggo** para gerar automaticamente a documenta√ß√£o Swagger a partir de coment√°rios no c√≥digo.

### Instala√ß√£o do Swag CLI
```bash
go install github.com/swaggo/swag/cmd/swag@latest
```

### Gerar documenta√ß√£o
```bash
swag init
```

## üß™ Testando a API

### Usando cURL
Veja os exemplos na se√ß√£o "Exemplo de Uso" acima.

### Usando Postman/Insomnia
1. Importe a cole√ß√£o do Swagger: `http://localhost:8080/swagger/doc.json`
2. Configure o token Bearer nas rotas protegidas

## ü§ù Contribuindo

1. Fa√ßa um fork do projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

## üìù Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo [LICENSE](LICENSE) para mais detalhes.

## üë®‚Äçüíª Autor

**Vitor Benevento** - [GitHub](https://github.com/Pmmvito)

---